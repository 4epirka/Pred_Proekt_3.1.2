<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { min-height: 100vh; }
        .sidebar { min-height: 100vh; padding-top: 0.75rem; }
        .sidebar .nav-link { border-radius: 0; }
        .topbar-text { font-weight: 600; color: #fff; }
        .card-table { background: #fff; border: 1px solid #e6e6e6; }
        .btn-edit { background-color: #17a2b8; border-color: #17a2b8; color: #fff; }
        .btn-edit:hover { background-color: #138496; border-color: #117a8b; color: #fff; }
        input.form-control, select.form-select { background-color: #fff8dc; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <div class="d-flex align-items-center">
            <span class="topbar-text me-3" th:text="${#authentication.name} ?: ''">admin@mail.ru</span>
            <small class="text-muted text-white-50" th:text="'with roles: ' + ${#authentication.authorities}"></small>
        </div>
        <div>
            <a th:href="@{/logout}" class="text-white text-decoration-none">Logout</a>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">

        <aside class="col-md-2 bg-light sidebar border-end">
            <ul class="nav flex-column nav-pills ms-2">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" th:href="@{/admin}">Admin</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user}">User</a>
                </li>
            </ul>
        </aside>

        <main class="col-md-10 p-4">
            <h1>Admin panel</h1>

            <ul class="nav nav-tabs mt-3">
                <li class="nav-item">
                    <a class="nav-link active" href="#">Users table</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/new}">New User</a>
                </li>
            </ul>

            <div class="card mt-3 card-table shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">All users</h5>

                    <div class="table-responsive mt-3">
                        <table class="table table-hover table-bordered align-middle mb-0">
                            <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Country</th>
                                <th>Roles</th>
                                <th style="width:160px">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="u : ${users}">
                                <td th:text="${u.id}"></td>
                                <td th:text="${u.username}"></td>
                                <td th:text="${u.name}"></td>
                                <td th:text="${u.age}"></td>
                                <td th:text="${u.country}"></td>
                                <td th:text="${u.roles}"></td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <button type="button"
                                                class="btn btn-sm btn-edit"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editUserModal"
                                                th:data-id="${u.id}"
                                                th:data-username="${u.username}"
                                                th:data-name="${u.name}"
                                                th:data-age="${u.age}"
                                                th:data-country="${u.country}"
                                                th:data-roles="${u.roles}">
                                            Edit
                                        </button>

                                        <button type="button"
                                                class="btn btn-sm btn-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteUserModal"
                                                th:data-id="${u.id}"
                                                th:data-username="${u.username}"
                                                th:data-name="${u.name}"
                                                th:data-age="${u.age}"
                                                th:data-country="${u.country}"
                                                th:data-roles="${u.roles}">
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </main>
    </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="editUserForm">
                <div class="modal-body">

                    <input type="hidden" id="edit-id" name="id">

                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" id="edit-username" name="username" class="form-control" placeholder="Enter username" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" id="edit-name" name="name" class="form-control" placeholder="Enter name">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Age</label>
                        <input type="number" id="edit-age" name="age" class="form-control" placeholder="Enter age" min="0" max="120">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Country</label>
                        <input type="text" id="edit-country" name="country" class="form-control" placeholder="Enter country">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" id="edit-password" name="password" class="form-control" placeholder="Enter new password">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Roles</label>
                        <select id="edit-roles" name="roles" class="form-select" multiple>
                            <option th:each="role : ${roles}"
                                    th:value="${role.id}"
                                    th:text="${role.name}">
                            </option>
                        </select>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteUserLabel">Delete user</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="deleteUserForm">
                <div class="modal-body">

                    <input type="hidden" id="delete-id" name="id">

                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" id="delete-username" class="form-control" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" id="delete-name" class="form-control" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Age</label>
                        <input type="number" id="delete-age" class="form-control" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Country</label>
                        <input type="text" id="delete-country" class="form-control" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Roles</label>
                        <select id="delete-roles" class="form-select" multiple disabled>
                            <option th:each="role : ${roles}"
                                    th:value="${role.id}"
                                    th:text="${role.name}">
                            </option>
                        </select>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const editModal = document.getElementById("editUserModal");
        const form = document.getElementById("editUserForm");

        editModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            document.getElementById("edit-id").value = button.getAttribute("data-id");
            document.getElementById("edit-username").value = button.getAttribute("data-username");
            document.getElementById("edit-name").value = button.getAttribute("data-name");
            document.getElementById("edit-age").value = button.getAttribute("data-age");
            document.getElementById("edit-country").value = button.getAttribute("data-country");

            const rolesSelect = document.getElementById("edit-roles");
            const userRolesString = button.getAttribute("data-roles") || "";
            const userRoles = userRolesString.replace(/[\[\]]/g, "").split(",").map(r => r.trim());
            for (let option of rolesSelect.options) {
                option.selected = userRoles.includes(option.text);
            }
        });

        form.addEventListener("submit", async function (e) {
            e.preventDefault();
            const formData = new FormData(form);
            const userId = formData.get("id");
            const response = await fetch(`/admin/update/${userId}`, { method: "POST", body: formData });
            if (response.ok) {
                bootstrap.Modal.getInstance(editModal).hide();
                location.reload();
            } else { alert("Ошибка при обновлении пользователя"); }
        });

        const deleteModal = document.getElementById("deleteUserModal");
        const deleteForm = document.getElementById("deleteUserForm");

        deleteModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            document.getElementById("delete-id").value = button.getAttribute("data-id");
            document.getElementById("delete-username").value = button.getAttribute("data-username");
            document.getElementById("delete-name").value = button.getAttribute("data-name");
            document.getElementById("delete-age").value = button.getAttribute("data-age");
            document.getElementById("delete-country").value = button.getAttribute("data-country");

            const rolesSelect = document.getElementById("delete-roles");
            const userRolesString = button.getAttribute("data-roles") || "";
            const userRoles = userRolesString.replace(/[\[\]]/g, "").split(",").map(r => r.trim());
            for (let option of rolesSelect.options) {
                option.selected = userRoles.includes(option.text);
            }
        });

        deleteForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            const userId = document.getElementById("delete-id").value;
            const response = await fetch(`/admin/delete/${userId}`, { method: "POST" });
            if (response.ok) {
                bootstrap.Modal.getInstance(deleteModal).hide();
                location.reload();
            } else { alert("Ошибка при удалении пользователя"); }
        });
    });
</script>

</body>
</html>
